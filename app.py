import streamlit as st
from google import genai
from google.genai import types
import os
from datetime import datetime
# Google Sheets ì—°ë™ì„ ìœ„í•œ Streamlit Connection ì¶”ê°€
st.cache_data.clear() # ìºì‹œ ë°ì´í„° í´ë¦¬ì–´
conn = st.connection("gsheets", type=st.connections.SnowflakeConnection)


# -----------------------------------------------------
# 1. API ì„¤ì • ë° ëª¨ë¸ ì´ˆê¸°í™”
# -----------------------------------------------------
api_key = "AIzaSyAU1iwa-OFdgFyiookp8Rcwez6rlNXajm4"

if not api_key:
    st.error("âš ï¸ API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    st.stop()

client = genai.Client(api_key=api_key)
model_name = 'gemini-2.5-flash' 
# ... (SYSTEM_INSTRUCTION ìƒëµ - ì´ì „ í”„ë¡¬í”„íŠ¸ ìœ ì§€) ... 
SYSTEM_INSTRUCTION = """
ë‹¹ì‹ ì€ ê³ ë“±í•™êµ 1í•™ë…„ ìˆ˜í•™ 'ëª…ì œ' ë‹¨ì›ì˜ ì „ë¬¸ íŠœí„°ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ëª©í‘œëŠ” í•™ìƒì˜ ë…¼ë¦¬ì  ì‚¬ê³ ë ¥ì„ í–¥ìƒì‹œí‚¤ê³ , ìŠ¤ìŠ¤ë¡œ ì˜¤ë¥˜ë¥¼ ë°œê²¬í•˜ë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.

[ì…ë ¥ ëª…ì œ ê²€í†  ì›ì¹™]
1. **í•„ìˆ˜ì–´ í™•ì¸**: ì…ë ¥ëœ ëª…ì œê°€ **'ëª¨ë“ '** ë˜ëŠ” **'ì–´ë–¤'** ì¤‘ í•˜ë‚˜ë¥¼ í¬í•¨í•˜ê³  ìˆì§€ ì•Šë‹¤ë©´, ë‹µë³€ ëŒ€ì‹  "**ëª…ì œì—ëŠ” 'ëª¨ë“ ' ë˜ëŠ” 'ì–´ë–¤'ì´ë¼ëŠ” ìš©ì–´ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.**"ë¼ê³  ì¶œë ¥í•©ë‹ˆë‹¤.
2. **ìˆ˜í•™ì  ëª…ì œ í•œì •**: ëª…ì œì— í¬í•¨ëœ ì§‘í•©(ìì—°ìˆ˜, ì‹¤ìˆ˜, ì§‘í•©, ë„í˜• ë“±)ì´ë‚˜ ì¡°ê±´ì´ ìˆ˜í•™ê³¼ ê´€ë ¨ì´ ì—†ëŠ” ê²½ìš°, ë‹µë³€ ëŒ€ì‹  "**ìˆ˜í•™ê³¼ ê´€ë ¨ëœ ëª…ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.**"ë¼ê³  ì¶œë ¥í•©ë‹ˆë‹¤.
3. **ë‘ ê°€ì§€ ê²€í†  ì›ì¹™ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ë˜ë©´ ì¦‰ì‹œ ë‹µë³€ì„ ì¤‘ë‹¨í•˜ê³  í•´ë‹¹ ë©”ì‹œì§€ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.**

[í•™ìƒì˜ ì…ë ¥ í˜•ì‹]
1. ëª…ì œ: [í•™ìƒì´ ì…ë ¥í•œ ëª…ì œ] (ì˜ˆ: ëª¨ë“  ìì—°ìˆ˜ xì— ëŒ€í•´ x^2 > x ì´ë‹¤.)
2. í•™ìƒì˜ íŒë‹¨: [ì°¸ / ê±°ì§“]
3. í•™ìƒì´ ìƒê°í•˜ëŠ” ì´ìœ /ê·¼ê±°/ë°˜ë¡€: [í•™ìƒì´ ì§ì ‘ ì‘ì„±í•œ ì´ìœ ]

[ë‹¹ì‹ ì˜ í”¼ë“œë°± ì›ì¹™]
1. **ì •í™•ì„± í™•ì¸**: ëª…ì œì˜ ì‹¤ì œ ì°¸/ê±°ì§“ ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
2. **ì‚¬ê³  ìœ ë„ ì§ˆë¬¸ (ê°€ì¥ ì¤‘ìš”)**:
    * ë§Œì•½ í•™ìƒì˜ **ì°¸/ê±°ì§“ íŒë‹¨ì´ í‹€ë ¸ê±°ë‚˜** **ì œì‹œí•œ ì´ìœ /ê·¼ê±°/ë°˜ë¡€ê°€ ë…¼ë¦¬ì ìœ¼ë¡œ ì˜ëª»ëœ ê²½ìš°**, ì˜¬ë°”ë¥¸ ì •ë‹µì´ë‚˜ ë°˜ë¡€ë¥¼ ë°”ë¡œ ì•Œë ¤ì£¼ì§€ ë§ˆì„¸ìš”.
    * ëŒ€ì‹ , í•™ìƒì´ ìŠ¤ìŠ¤ë¡œ ì˜¤ë¥˜ë¥¼ ë°œê²¬í•˜ê³  ìƒê°í•  ìˆ˜ ìˆë„ë¡ **êµ¬ì²´ì ì´ê³  í•µì‹¬ì„ ì§šëŠ” ì§ˆë¬¸**ì„ í•˜ë‚˜ ë˜ëŠ” ë‘ ê°œ ì¶œë ¥í•©ë‹ˆë‹¤. (ì˜ˆ: "ë§Œì•½ xì— 1ì„ ëŒ€ì…í•œë‹¤ë©´ ê·¸ ì¡°ê±´ì€ ì°¸ì¸ê°€ìš”?", "'ì–´ë–¤'ì˜ ì˜ë¯¸ëŠ” ëª¨ë“  ê²½ìš°ê°€ ì•„ë‹Œ 'ë‹¨ í•˜ë‚˜'ì˜ ê²½ìš°ë§Œ ìˆìœ¼ë©´ ëœë‹¤ëŠ” ê²ƒì„ ê¸°ì–µí•´ ë³´ì„¸ìš”.")
3. **íŒë‹¨ ì¼ì¹˜ ì‹œ ë³´ê°•**:
    * **ì°¸/ê±°ì§“ê³¼ ì´ìœ ê°€ ëª¨ë‘ ë…¼ë¦¬ì ìœ¼ë¡œ ì™„ë²½í•  ê²½ìš°**: "ë…¼ë¦¬ì ìœ¼ë¡œ ì™„ë²½í•´ìš”!ğŸ‘"ë¼ê³  ì¹­ì°¬í•˜ê³ , í•™ìƒì˜ ì´ìœ ë¥¼ ë³´ê°•í•˜ëŠ” ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ë” ì¼ë°˜ì ì¸ ì¦ëª… ì›ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
4. **ë§ˆì§€ë§‰ ì§ˆë¬¸**: í•™ìƒì´ ë‹¤ìŒ ëª…ì œë¥¼ ì…ë ¥í•˜ë„ë¡ ìœ ë„í•˜ëŠ” ì§ˆë¬¸ì„ ë§ë¶™ì…ë‹ˆë‹¤.
"""


# -----------------------------------------------------
# 3. Streamlit ì›¹ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ - ì œëª© ìˆ˜ì • ì™„ë£Œ
# -----------------------------------------------------

st.set_page_config(page_title="'ëª¨ë“ 'ì´ë‚˜ 'ì–´ë–¤'ì´ í¬í•¨ëœ ëª…ì œ ë…¼ë¦¬ íŠœí„° ì±—ë´‡", layout="centered")
st.title("ğŸ‘¨â€ğŸ« 'ëª¨ë“ 'ì´ë‚˜ 'ì–´ë–¤'ì´ í¬í•¨ëœ ëª…ì œ ë…¼ë¦¬ íŠœí„° ì±—ë´‡")
st.markdown("ëª…ì œë¥¼ ì…ë ¥í•˜ê³ , ë³¸ì¸ì˜ íŒë‹¨ê³¼ ì´ìœ ë¥¼ ì ì–´ **ì¦‰ê°ì ì¸ ë…¼ë¦¬ í”¼ë“œë°±**ì„ ë°›ì•„ë³´ì„¸ìš”. (ë‹¨, ëª…ì œëŠ” **'ëª¨ë“ '** ë˜ëŠ” **'ì–´ë–¤'**ì„ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.)")

# í¼ ìƒì„± (ì¦‰ê°ì ì¸ ì‘ë‹µì„ ìœ„í•´ st.form ì‚¬ìš©)
with st.form(key='tutor_form'):
    user_proposition = st.text_input("1. ëª…ì œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: ëª¨ë“  ìì—°ìˆ˜ xì— ëŒ€í•´ xÂ² > x ì´ë‹¤.)", key="prop_input")
    user_judgment = st.radio(
        "2. í•™ìƒì˜ íŒë‹¨ì€ ë¬´ì—‡ì¸ê°€ìš”?",
        ('ì°¸', 'ê±°ì§“'),
        index=None,
        key="judg_radio"
    )
    user_reason = st.text_area("3. ê·¸ë ‡ê²Œ íŒë‹¨í•œ ì´ìœ /ê·¼ê±°/ë°˜ë¡€ë¥¼ ì¨ì£¼ì„¸ìš”. (êµ¬ì²´ì ì¼ìˆ˜ë¡ ì¢‹ì•„ìš”!)", key="reason_input")
    
    # ì œì¶œ ë²„íŠ¼
    submit_button = st.form_submit_button(label='í”¼ë“œë°± ìš”ì²­í•˜ê¸°')

# ì œì¶œ ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ ë¡œì§
if submit_button:
    if not user_proposition or not user_judgment or not user_reason:
        st.error("ëª¨ë“  í•­ëª©(ëª…ì œ, íŒë‹¨, ì´ìœ )ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        st.stop()
        
    user_message = f"""
    [í•™ìƒì˜ ì…ë ¥]
    1. ëª…ì œ: {user_proposition}
    2. í•™ìƒì˜ íŒë‹¨: {user_judgment}
    3. í•™ìƒì´ ìƒê°í•˜ëŠ” ì´ìœ /ê·¼ê±°/ë°˜ë¡€: {user_reason}
    
    ìœ„ ì…ë ¥ì— ëŒ€í•´ ì—„ê²©í•œ í”¼ë“œë°± ì›ì¹™ì„ ë”°ë¼ ë…¼ë¦¬ì ì¸ íŠœí„°ë§ í”¼ë“œë°±ì„ ì œê³µí•´ ì£¼ì„¸ìš”.
    """
    
    with st.spinner('âœ¨ AI íŠœí„°ê°€ ë…¼ë¦¬ë¥¼ ë¶„ì„í•˜ê³  í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...'):
        try:
            response = client.models.generate_content(
                model=model_name,
                contents=user_message,
                config=types.GenerateContentConfig(
                    system_instruction=SYSTEM_INSTRUCTION
                )
            )
            
            ai_feedback = response.text # AI í”¼ë“œë°± ì €ì¥
            
            # --- ë°ì´í„° ì €ì¥ ë¡œì§ (ì¶”ê°€ëœ í•µì‹¬ ë¶€ë¶„) ---
            # 1. ì‹œíŠ¸ ì´ë¦„ì€ 'Sheet1' (Google Sheets ê¸°ë³¸ê°’)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
            # 2. í–‰ ì¶”ê°€ (append) ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ Google Sheetsì— ë°ì´í„° ê¸°ë¡
            conn.append('Sheet1', data=[
                [
                    datetime.now().strftime("%Y-%m-%d %H:%M:%S"), # ì‹œê°„
                    user_proposition, 
                    user_judgment, 
                    user_reason, 
                    ai_feedback
                ]
            ])
            # ---------------------------------------------

            st.success("ğŸ‰ í”¼ë“œë°±ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!")
            st.markdown(ai_feedback)
            
        except Exception as e:
            st.error(f"API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”. (ì˜¤ë¥˜: {e})")
